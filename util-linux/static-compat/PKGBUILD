# Contributor: Tom Gundersen <teg@jklm.no>
# Contributor: Dave Reisner <dreisner@archlinux.org>
# Contributor: judd <jvinet@zeroflux.org>

_pkgname=util-linux
pkgname=static-compat-$_pkgname
pkgver=2.41.2
pkgrel=1
pkgdesc='Miscellaneous system utilities for Linux'
url='https://github.com/karelzak/util-linux'
arch=('x86_64')
depends=('glibc-static-compat')
makedepends=('systemd' 'python' 'libcap-ng' 'libxcrypt' 'git' 'static-compat-configure')
license=(
  'BSD-2-Clause'
  'BSD-3-Clause'
  'BSD-4-Clause-UC'
  'GPL-2.0-only'
  'GPL-2.0-or-later'
  'GPL-3.0-or-later'
  'ISC'
  'LGPL-2.1-or-later'
  'LicenseRef-PublicDomain'
)
options=(!emptydirs staticlibs strip)
validpgpkeys=('B0C64D14301CC6EFAEDF60E4E4B71D5EEC39C284')  # Karel Zak
options=(staticlibs)
source=("git+https://github.com/util-linux/util-linux#tag=v${pkgver/rc/-rc}")
sha256sums=('d7fec66283cce093f54aaf0f30dcb6adfea7c7c170abf8cdf24df3c409397f87'
            'SKIP')

prepare() {
  source static-compat-environment
  cd "$_pkgname"
  ./autogen.sh
}

build() {
  source static-compat-environment
  cd "$_pkgname"

  # We ship Debian's hardlink in package 'hardlink', Fedora's hardlink was
  # merged in util-linux. For now we disable the latter, but let's dicuss
  # the details:
  # https://bugs.archlinux.org/task/62896
  # https://github.com/karelzak/util-linux/issues/808

  static-compat-configure \
    --libdir="$static_compat_prefix"/lib \
    --bindir="$static_compat_prefix"/bin \
    --sbindir="$static_compat_prefix"/bin \
    --localstatedir=/var \
    --disable-shared \
    --enable-static \
    --enable-usrdir-path \
    --enable-libuuid-force-uuidd \
    --enable-libblkid \
    --enable-libmount \
    --enable-libsmartcols \
    --enable-libfdisk \
    --disable-fdisks \
    --disable-mount \
    --disable-losetup \
    --disable-zramctl \
    --disable-fsck \
    --disable-partx \
    --disable-uuidd \
    --disable-wipefs \
    --disable-mountpoint \
    --disable-fallocate \
    --disable-unshare \
    --disable-nsenter \
    --disable-setpriv \
    --disable-hardlink \
    --disable-eject \
    --disable-agetty \
    --disable-plymouth_support \
    --without-libmagic \
    --disable-cramfs \
    --disable-bfs \
    --disable-minix \
    --disable-fdformat \
    --disable-hwclock \
    --disable-hwclock-gplv3 \
    --disable-lslogins \
    --disable-wdctl \
    --disable-cal \
    --disable-logger \
    --disable-whereis \
    --disable-switch_root \
    --disable-pivot_root \
    --disable-lsmem \
    --disable-chmem \
    --disable-ipcrm \
    --disable-ipcmk \
    --disable-ipcs \
    --disable-irqtop \
    --disable-lsirq \
    --disable-rfkill \
    --disable-tunelp \
    --disable-kill \
    --disable-last \
    --disable-utmpdump \
    --enable-line \
    --disable-mesg \
    --disable-raw \
    --disable-rename \
    --disable-vipw \
    --disable-newgrp \
    --disable-chfn-chsh \
    --disable-login \
    --disable-nologin \
    --disable-sulogin \
    --disable-su \
    --disable-runuser \
    --disable-ul \
    --disable-more \
    --disable-pg \
    --disable-setterm \
    --disable-schedutils \
    --disable-wall \
    --disable-write \
    --disable-liblastlog2 \
    --disable-lsfd \
    --without-systemd \
    --without-python \
    --disable-pylibmount \
    --disable-chfn-chsh-password \
    --disable-fstrim \
    --disable-swapon \
    --disable-lsblk \
    --disable-lscpu
  make
}

package() {
  source static-compat-environment
  cd "$_pkgname"

  make DESTDIR="$pkgdir" install
  rm -r "$pkgdir/$static_compat_prefix"/{sbin,bin}
  rm -r "$pkgdir/$static_compat_prefix"/share/{locale,man,doc,bash-completion}
}
